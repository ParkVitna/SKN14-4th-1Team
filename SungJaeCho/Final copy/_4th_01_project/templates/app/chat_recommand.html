{% extends "../layout/base.html" %}
{% load static %}
{% block style %}
    <link rel="stylesheet" href="{% static 'css/chat_recommand.css' %}">
{% endblock style %}

{% block content %}
    <div class="container-fluid py-4">
        <div class="main-container">
            <!-- Page Header -->
            <div class="page-header">
                <h1><i class="fas fa-comments me-3"></i>질의응답 시스템</h1>
                <p class="lead mb-0">건강기능식품에 대한 궁금증을 해결해드립니다</p>
            </div>

            <!-- Sample Questions -->
            <div class="sample-questions">
                <h6 class="mb-3"><i class="fas fa-question-circle me-2"></i>자주 묻는 질문</h6>
                <div class="row g-2">
                    <div class="col-md-4">
                        <button class="btn btn-outline-primary w-100 sample-question" data-question="피부에 좋은 영양제 추천해주세요">
                            <i class="fas fa-spa me-2"></i>피부에 좋은 영양제는?
                        </button>
                    </div>
                    <div class="col-md-4">
                        <button class="btn btn-outline-success w-100 sample-question" data-question="피로 회복에 도움이 되는 영양제는 무엇인가요?">
                            <i class="fas fa-bolt me-2"></i>피로 회복에 도움되는 것은?
                        </button>
                    </div>
                    <div class="col-md-4">
                        <button class="btn btn-outline-info w-100 sample-question" data-question="비타민D와 칼슘을 같이 먹어도 되나요?">
                            <i class="fas fa-question me-2"></i>비타민D와 칼슘 같이 복용 가능한가요?
                        </button>
                    </div>
                </div>
                <div class="row g-2 mt-2">
                    <div class="col-md-4">
                        <button class="btn btn-outline-warning w-100 sample-question" data-question="임신 중에 먹으면 안되는 영양제가 있나요?">
                            <i class="fas fa-baby me-2"></i>임신 중 주의사항은?
                        </button>
                    </div>
                    <div class="col-md-4">
                        <button class="btn btn-outline-danger w-100 sample-question" data-question="오메가3의 효능과 부작용을 알려주세요">
                            <i class="fas fa-fish me-2"></i>오메가3 정보
                        </button>
                    </div>
                    <div class="col-md-4">
                        <button class="btn btn-outline-secondary w-100 sample-question" data-question="종합비타민은 언제 먹는 것이 가장 좋나요?">
                            <i class="fas fa-clock me-2"></i>복용 시간 문의
                        </button>
                    </div>
                </div>
            </div>

            <!-- Chat Container -->
            <div class="chat-container">
                <!-- Chat History -->
                <div class="chat-history" id="chatHistory">
                    <div class="bot-message">
                        <strong><i class="fas fa-robot me-2"></i>NutriWise AI</strong><br>
                        안녕하세요! 건강기능식품에 대해 궁금한 것이 있으시면 언제든 물어보세요. 식품의약품안전처 데이터를 기반으로 정확한 정보를 제공해드리겠습니다.
                    </div>
                </div>

                <!-- Typing Indicator -->
                <div class="typing-indicator" id="typingIndicator">
                    <strong><i class="fas fa-robot me-2"></i>NutriWise AI가 답변 중입니다...</strong>
                    <div class="typing-dots mt-2">
                        <span></span>
                        <span></span>
                        <span></span>
                    </div>
                </div>

                <!-- Chat Input -->
                <div class="chat-input-area">
                    <div class="input-group">
                        <input type="text" class="form-control" placeholder="건강기능식품에 대해 궁금한 것을 물어보세요..." id="chatInput">
                        <button class="btn btn-gradient" type="button" id="sendChat">
                            <i class="fas fa-paper-plane me-2"></i>전송
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
{% endblock content %}

{% block script %}
<script>
    // DOM elements
    const chatInput = document.getElementById('chatInput');
    const sendButton = document.getElementById('sendChat');
    const chatHistory = document.getElementById('chatHistory');
    const typingIndicator = document.getElementById('typingIndicator');
    const sampleQuestions = document.querySelectorAll('.sample-question');

    // CSRF 토큰 가져오기
    function getCSRFToken() {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, 10) === ('csrftoken=')) {
                    cookieValue = decodeURIComponent(cookie.substring(10));
                    break;
                }
            }
        }
        return cookieValue;
    }

    // Event listeners
    sendButton.addEventListener('click', sendMessage);
    chatInput.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            sendMessage();
        }
    });

    sampleQuestions.forEach(button => {
        button.addEventListener('click', function() {
            const question = this.getAttribute('data-question');
            chatInput.value = question;
            sendMessage();
        });
    });

    function sendMessage() {
        const message = chatInput.value.trim();
        if (!message) return;

        addMessage(message, 'user');
        chatInput.value = '';
        showTypingIndicator();

        fetch('/app/chatbot/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCSRFToken()
            },
            body: JSON.stringify({ question: message, use_ocr: false })
        })
        .then(response => response.json())
        .then(data => {
            hideTypingIndicator();
            addMessage(data.response, 'bot');
        })
        .catch(error => {
            hideTypingIndicator();
            addMessage("죄송합니다. 서버와 연결할 수 없습니다.", 'bot');
            console.error('Error:', error);
        });
    }

    function addMessage(message, sender) {
        const messageDiv = document.createElement('div');
        messageDiv.className = `chat-message ${sender}-message`;

        if (sender === 'user') {
            messageDiv.innerHTML = `<strong><i class="fas fa-user me-2"></i>나:</strong><br>${message}`;
        } else {
            messageDiv.innerHTML = `<strong><i class="fas fa-robot me-2"></i>NutriWise AI:</strong><br>${message.replace(/\n/g, '<br>')}`;
        }

        chatHistory.appendChild(messageDiv);
        chatHistory.scrollTop = chatHistory.scrollHeight;
    }

    function showTypingIndicator() {
        typingIndicator.style.display = 'block';
        chatHistory.scrollTop = chatHistory.scrollHeight;
    }

    function hideTypingIndicator() {
        typingIndicator.style.display = 'none';
    }

    // Auto-focus on input
    chatInput.focus();
</script>
{% endblock script %}